<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKTA - Pro Study Tracker & Streak</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- PWA Metadata -->
    <link rel="manifest" id="pwa-manifest">
    <meta name="theme-color" content="#06b6d4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.08);
            --accent: #06b6d4;
            --accent-glow: rgba(6, 182, 212, 0.4);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --danger: #f43f5e;
            --bg-blur: 25px;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #020617 url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.5;
            user-select: none;
        }

        body::before {
            content: ''; position: fixed; inset: 0;
            background: radial-gradient(circle at top right, rgba(6, 182, 212, 0.1), transparent),
                        linear-gradient(to bottom, rgba(2, 6, 23, 0.85), rgba(2, 6, 23, 0.98));
            z-index: -1;
        }

        .navbar {
            backdrop-filter: blur(var(--bg-blur));
            background: rgba(15, 23, 42, 0.4);
            padding: 1rem 5%;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--glass-border);
            position: sticky; top: 0; z-index: 1000;
        }

        .logo { display: flex; align-items: center; gap: 0.8rem; }
        .logo-icon { 
            width: 42px; height: 42px; background: linear-gradient(135deg, var(--accent), #3b82f6);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; box-shadow: 0 0 20px var(--accent-glow);
        }

        .streak-counter {
            background: rgba(255, 107, 0, 0.15);
            border: 1px solid rgba(255, 107, 0, 0.3);
            padding: 5px 12px;
            border-radius: 50px;
            display: flex; align-items: center; gap: 6px;
            color: #ff9d00; font-weight: 700; font-size: 13px;
        }

        .main-container {
            display: grid; grid-template-columns: 1fr 380px; gap: 2rem;
            max-width: 1400px; margin: 2rem auto; padding: 0 5%;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--bg-blur));
            border: 1px solid var(--glass-border);
            border-radius: 24px; padding: 1.5rem;
            transition: 0.3s;
        }

        .section-header {
            font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--accent);
            letter-spacing: 2px; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 8px;
        }

        .timer-circle-wrap {
            display: flex; flex-direction: column; align-items: center; margin: 1rem 0;
        }
        .timer-circle {
            width: 280px; height: 280px; border-radius: 50%;
            border: 4px solid var(--glass-border);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: 0.5s;
            background: radial-gradient(circle, rgba(6, 182, 212, 0.08) 0%, transparent 80%);
        }
        .timer-circle.running { border-color: var(--accent); box-shadow: 0 0 40px var(--accent-glow); animation: breathe 4s infinite; }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.02); opacity: 1; }
        }

        .timer-display {
            font-family: 'JetBrains Mono', monospace; font-size: 68px; font-weight: 700;
            line-height: 1; text-shadow: 0 0 20px var(--accent-glow);
        }

        .quote-box {
            text-align: center; margin-top: 1rem; font-size: 13px; font-style: italic;
            color: var(--text-secondary); max-width: 400px; min-height: 40px;
        }

        .duration-controls { display: flex; align-items: center; gap: 20px; margin: 1.5rem 0; }
        .time-adjust-btn {
            width: 40px; height: 40px; border-radius: 12px; background: var(--glass-highlight);
            border: 1px solid var(--glass-border); color: white; cursor: pointer; font-size: 20px;
            transition: 0.2s;
        }
        .time-adjust-btn:hover { background: var(--accent); }

        .btn-primary {
            padding: 0.8rem 2.5rem; background: linear-gradient(135deg, var(--accent), #3b82f6);
            border: none; border-radius: 50px; color: white; font-weight: 700; font-size: 14px;
            cursor: pointer; box-shadow: 0 8px 20px var(--accent-glow); transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-outline {
            padding: 0.7rem 1.2rem; background: var(--glass-highlight); border: 1px solid var(--glass-border);
            border-radius: 50px; color: white; font-weight: 600; cursor: pointer; transition: 0.3s;
            font-size: 12px;
        }

        .subject-item, .todo-item {
            display: flex; align-items: center; gap: 10px; padding: 0.8rem;
            background: rgba(255,255,255,0.03); border-radius: 16px; margin-bottom: 0.6rem;
            border: 1px solid transparent; transition: 0.2s;
        }
        .subject-item.active { border-color: var(--accent); background: rgba(6, 182, 212, 0.12); }
        .todo-item:hover, .subject-item:hover { background: rgba(255,255,255,0.08); }
        .todo-item.task-done { opacity: 0.5; filter: grayscale(1); }
        
        .delete-btn {
            background: transparent; border: none; color: var(--danger);
            cursor: pointer; font-size: 18px; padding: 0 5px; opacity: 0.4; transition: opacity 0.2s;
        }
        .delete-btn:hover { opacity: 1; }

        .floating-window {
            position: fixed; bottom: 30px; right: 30px; width: 220px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
            display: none; z-index: 10000;
            padding: 1rem; cursor: grab; transition: height 0.3s ease;
            overflow: hidden;
        }
        .floating-window.active { display: block; }

        .mini-tasks-container {
            margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 10px; max-height: 200px; overflow-y: auto;
            display: none;
        }
        .mini-tasks-container.expanded { display: block; }

        .activity-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(12px, 1fr)); gap: 4px;
            margin-top: 1rem;
        }
        .activity-cell { aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 2px; }
        .cell-1 { background: #0891b2; }
        .cell-max { background: #22d3ee; box-shadow: 0 0 8px var(--accent); }

        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(12px);
            display: none; align-items: center; justify-content: center; z-index: 20000;
        }
        .modal.active { display: flex; }

        #confettiCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 25000;
        }

        #retrySyncBtn {
            display: none; margin-top: 5px; font-size: 9px; background: var(--danger);
            border: none; color: white; padding: 2px 6px; border-radius: 4px; cursor: pointer;
        }

        #pipVideo {
            position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none;
        }

        @media (max-width: 1024px) { .main-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <canvas id="confettiCanvas"></canvas>
    <!-- Always on Display Floating Elements -->
    <video id="pipVideo" autoplay muted playsinline></video>
    <canvas id="pipCanvas" width="300" height="150" style="display:none;"></canvas>

    <div id="notification-overlay" class="modal">
        <div style="text-align: center; background: var(--glass-bg); padding: 3rem; border-radius: 32px; border: 1px solid var(--accent); max-width: 350px;">
            <div style="font-size: 50px; margin-bottom: 1rem;">üî•</div>
            <h2 style="font-size: 24px;">Shabash!</h2>
            <p style="color: var(--text-secondary); margin: 1rem 0 2rem;">Apni ekta session sesh korechen. Carry on!</p>
            <button class="btn-primary" style="width: 100%;" onclick="app.closeNotif()">Alhamdulillah</button>
        </div>
    </div>

    <nav class="navbar">
        <div class="logo">
            <div class="logo-icon">üöÄ</div>
            <div class="logo-text">
                <h1>AKTA</h1>
                <div style="display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--text-secondary);">
                    <div id="authDot" style="width: 6px; height: 6px; border-radius: 50%; background: #475569;"></div>
                    <span id="authText">Syncing...</span>
                    <button id="retrySyncBtn" onclick="switchToLocalMode('Local Mode Force')">Switch to Local</button>
                </div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="streak-counter" title="Daily Streak">
                <span>üî•</span> <span id="streakVal">0</span> Days
            </div>
            <button class="btn-outline" id="miniModeBtn">üìå Mini Mode</button>
            <button class="btn-outline" onclick="app.showSettings()">‚öôÔ∏è</button>
        </div>
    </nav>

    <div class="main-container">
        <div class="content-main">
            <div class="card" style="margin-bottom: 1.5rem; text-align: center;">
                <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 2rem;">
                    <button class="btn-outline" id="mode-pomo" onclick="app.setMode('pomodoro')">Pomodoro</button>
                    <button class="btn-outline" id="mode-stop" onclick="app.setMode('stopwatch')">Stopwatch</button>
                </div>

                <div class="timer-circle-wrap">
                    <div style="background: rgba(6, 182, 212, 0.1); padding: 6px 15px; border-radius: 50px; font-size: 10px; font-weight: 800; color: var(--accent); margin-bottom: 1rem; border: 1px solid var(--glass-border);">
                        VISHAY: <span id="activeSub">GENERAL</span>
                    </div>

                    <div class="timer-circle" id="mainCircle">
                        <div class="timer-display" id="timerDisplay">25:00</div>
                        <div style="font-size: 10px; letter-spacing: 3px; color: var(--text-secondary); margin-top: 5px;" id="timerStatus">READY TO FOCUS</div>
                    </div>

                    <div class="quote-box" id="quoteDisplay">"The secret of getting ahead is getting started."</div>

                    <div class="duration-controls" id="durationAdjuster">
                        <button class="time-adjust-btn" onclick="app.adjustTime(-5)">-</button>
                        <div style="font-size: 11px; font-weight: 700; color: var(--text-secondary);">FOCUS TIME ADJUST</div>
                        <button class="time-adjust-btn" onclick="app.adjustTime(5)">+</button>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="btn-primary" id="startBtn" onclick="app.toggleTimer()">START</button>
                        <button class="btn-outline" onclick="app.resetTimer()">RESET</button>
                    </div>
                </div>

                <div style="display: flex; justify-content: center; gap: 8px; margin-top: 1rem;">
                    <button class="btn-outline" onclick="app.setDuration(25)">25m</button>
                    <button class="btn-outline" onclick="app.setDuration(50)">50m</button>
                    <button class="btn-outline" onclick="app.setDuration(5)">Break</button>
                </div>
            </div>

            <div class="card">
                <div class="section-header">üìö Study List</div>
                <div id="subList"></div>
                <button class="btn-outline" style="width: 100%; margin-top: 1rem; border-style: dashed;" onclick="app.openSubModal()">+ Add Subject</button>
            </div>
        </div>

        <div class="content-side">
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="section-header">üéØ Today's Goal</div>
                <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 8px;">
                    <span id="goalLabel">Progress</span>
                    <span id="goalText">0 / 120 min</span>
                </div>
                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;">
                    <div id="goalBar" style="width: 0%; height: 100%; background: var(--accent); box-shadow: 0 0 10px var(--accent); transition: 0.5s;"></div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="section-header">üìä Statistics</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="background: rgba(255,255,255,0.02); padding: 1rem; border-radius: 16px; text-align: center; border: 1px solid var(--glass-border);">
                        <div id="statSess" style="font-size: 22px; font-weight: 700;">0</div>
                        <div style="font-size: 9px; color: var(--text-secondary);">SESSIONS</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.02); padding: 1rem; border-radius: 16px; text-align: center; border: 1px solid var(--glass-border);">
                        <div id="statHrs" style="font-size: 22px; font-weight: 700;">0.0</div>
                        <div style="font-size: 9px; color: var(--text-secondary);">HOURS</div>
                    </div>
                </div>
                <div class="activity-grid" id="actGrid"></div>
            </div>

            <div class="card">
                <div class="section-header">üìù Quick Tasks</div>
                <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                    <input type="text" id="taskInp" style="flex:1; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 12px; color: white; padding: 0.6rem 1rem; outline: none;" placeholder="What to do next?">
                    <button class="btn-primary" style="padding: 0 1.2rem;" onclick="app.addTask()">+</button>
                </div>
                <div id="taskList"></div>
            </div>
        </div>
    </div>

    <!-- Mini Mode Window -->
    <div class="floating-window" id="floatWin">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 9px; font-weight: 800; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
            <span>MINI MODE</span>
            <button onclick="app.closeMini()" style="background: transparent; border: none; color: white; cursor: pointer;">‚úï</button>
        </div>
        <div id="miniTimerSection" style="text-align: center;">
            <div id="floatTimer" style="font-family: 'JetBrains Mono'; font-size: 38px; font-weight: 700; color: white; margin-bottom: 5px; text-shadow: 0 0 10px rgba(6,182,212,0.8);">25:00</div>
            <div id="floatSub" style="font-size: 9px; color: #e2e8f0; margin-bottom: 10px; font-weight: 600;">GENERAL</div>
            
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="btn-primary" style="padding: 0.5rem; background: rgba(6, 182, 212, 0.6);" onclick="app.toggleTimer()" id="floatPlay">START</button>
                
                <!-- PRO FLOATING BUTTON -->
                <button class="btn-outline" style="padding: 0.6rem; border-radius: 12px; background: #10b981; border: none; font-weight: 800; color: white; box-shadow: 0 4px 10px rgba(16,185,129,0.3);" onclick="app.openFloatingWindow()">üöÄ OPEN PRO FLOAT</button>
            </div>
            <p style="font-size: 8px; color: #94a3b8; margin-top: 10px; line-height: 1.2;">Use 'PRO FLOAT' for a real window that stays on top when minimized.</p>
        </div>
        <div id="miniTasksSection" class="mini-tasks-container">
            <div style="font-size: 9px; color: white; margin-bottom: 8px; font-weight: 800; letter-spacing: 1px;">QUICK TASKS</div>
            <div id="miniTaskList"></div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="subModal">
        <div class="modal-content" style="background: #0f172a; padding: 2rem; border-radius: 24px; width: 320px; border: 1px solid var(--glass-border);">
            <h3 style="margin-bottom: 1.2rem;">New Subject</h3>
            <input type="text" id="newSubInp" style="width:100%; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); padding:0.8rem; border-radius:12px; color:white;" placeholder="Name of subject">
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button class="btn-primary" style="flex: 1;" onclick="app.saveSub()">Save</button>
                <button class="btn-outline" style="flex: 1;" onclick="app.closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="setModal">
        <div class="modal-content" style="background: #0f172a; padding: 2rem; border-radius: 24px; width: 320px; border: 1px solid var(--glass-border);">
            <h3 style="margin-bottom: 1.2rem;">Settings</h3>
            <label style="font-size: 11px; color: var(--text-secondary);">Daily Goal (Minutes)</label>
            <input type="number" id="goalInp" style="width:100%; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); padding:0.8rem; border-radius:12px; color:white; margin-top:5px;">
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button class="btn-primary" style="flex: 1;" onclick="app.saveSettings()">Update</button>
                <button class="btn-outline" style="flex: 1;" onclick="app.closeModals()">Close</button>
            </div>
        </div>
    </div>

    <audio id="beep" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="taskBeep" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" preload="auto"></audio>

    <script type="text/javascript">
        // Global variables
        window.user = null; window.db = null; window.auth = null; 
        window.isLocalMode = false; window.connTimeout = null;
        const appId = 'akta-study-pro-final';

        const timer = { mode: 'pomodoro', timeLeft: 25 * 60, initialSecs: 25 * 60, isRunning: false, intv: null, sub: 'General', goal: 120 };
        const els = {
            display: document.getElementById('timerDisplay'), floatDisplay: document.getElementById('floatTimer'),
            circle: document.getElementById('mainCircle'), startBtn: document.getElementById('startBtn'),
            quote: document.getElementById('quoteDisplay'), streak: document.getElementById('streakVal'),
            canvas: document.getElementById('confettiCanvas'), miniTasks: document.getElementById('miniTasksSection'),
            authDot: document.getElementById('authDot'), authText: document.getElementById('authText'),
            retryBtn: document.getElementById('retrySyncBtn'), pipVideo: document.getElementById('pipVideo'),
            pipCanvas: document.getElementById('pipCanvas')
        };

        const getLocal = (key) => JSON.parse(localStorage.getItem(`akta_${key}`)) || [];
        const saveLocal = (key, data) => localStorage.setItem(`akta_${key}`, JSON.stringify(data));
        const quotes = ["Study now, be proud later.", "Dream it. Wish it. Do it.", "Stay focused and never give up."];

        window.firebaseFns = {};
        let lastLoadedTasks = [];

        window.switchToLocalMode = (msg) => {
            clearTimeout(window.connTimeout); window.isLocalMode = true;
            els.authText.innerText = msg; els.authDot.style.background = "#f59e0b";
            els.retryBtn.style.display = "none";
            syncStreak(); loadLocalData();
        };

        // Advanced Floating Window logic
        let pipWindow = null;
        window.app = {
            openFloatingWindow: async () => {
                if ('documentPictureInPicture' in window) {
                    try {
                        pipWindow = await window.documentPictureInPicture.requestWindow({ width: 300, height: 450 });
                        
                        // Copy styles
                        [...document.styleSheets].forEach((styleSheet) => {
                            try {
                                const cssRules = [...styleSheet.cssRules].map((rule) => rule.cssText).join('');
                                const style = document.createElement('style');
                                style.textContent = cssRules;
                                pipWindow.document.head.appendChild(style);
                            } catch (e) {}
                        });

                        pipWindow.document.body.style.background = '#020617';
                        pipWindow.document.body.style.margin = '0';
                        pipWindow.document.body.style.padding = '15px';
                        pipWindow.document.body.style.display = 'flex';
                        pipWindow.document.body.style.flexDirection = 'column';
                        pipWindow.document.body.style.overflowX = 'hidden';

                        const content = pipWindow.document.createElement('div');
                        content.innerHTML = `
                            <div style="text-align: center; margin-bottom: 15px;">
                                <div id="pip-sub" style="font-size: 10px; color: #06b6d4; font-weight: 800; margin-bottom: 5px;">${timer.sub.toUpperCase()}</div>
                                <div id="pip-display" style="font-family: 'JetBrains Mono', monospace; font-size: 55px; font-weight: 700; color: white; line-height: 1;">${els.display.innerText}</div>
                                <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center;">
                                    <button id="pip-toggle" style="background: #06b6d4; border: none; color: white; padding: 8px 20px; border-radius: 50px; font-weight: 700; cursor: pointer; font-size: 12px;">START</button>
                                </div>
                            </div>
                            <div id="pip-tasks-section" style="margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                                <div style="font-size: 10px; color: #94a3b8; margin-bottom: 10px; font-weight: 800; letter-spacing: 1px;">QUICK TASKS</div>
                                <div id="pip-task-list"></div>
                            </div>
                        `;
                        pipWindow.document.body.appendChild(content);

                        // Attach Event Listeners
                        pipWindow.document.getElementById('pip-toggle').onclick = () => window.app.toggleTimer();
                        
                        // Initial Task Load for PiP
                        renderTasks(lastLoadedTasks);
                        
                        pipWindow.onpagehide = () => { pipWindow = null; };

                    } catch (e) {
                        console.error("Document PiP failed", e);
                    }
                } else {
                    alert("PRO FLOAT requires a modern browser like Google Chrome or Microsoft Edge.");
                }
            },
            updateUI: () => {
                const m = Math.floor(Math.abs(timer.timeLeft) / 60).toString().padStart(2, '0');
                const s = (Math.abs(timer.timeLeft) % 60).toString().padStart(2, '0');
                const timeStr = `${m}:${s}`;
                els.display.innerText = timeStr; els.floatDisplay.innerText = timeStr;
                document.title = `${timeStr} | Focus`;

                if (pipWindow) {
                    const pipDisp = pipWindow.document.getElementById('pip-display');
                    const pipToggle = pipWindow.document.getElementById('pip-toggle');
                    const pipSub = pipWindow.document.getElementById('pip-sub');
                    if(pipDisp) pipDisp.innerText = timeStr;
                    if(pipSub) pipSub.innerText = timer.sub.toUpperCase();
                    if(pipToggle) pipToggle.innerText = timer.isRunning ? "PAUSE" : "START";
                }
            },
            setMode: (m) => {
                timer.mode = m; timer.isRunning = false; clearInterval(timer.intv);
                document.getElementById('mode-pomo').classList.toggle('active', m === 'pomodoro');
                document.getElementById('mode-stop').classList.toggle('active', m === 'stopwatch');
                document.getElementById('durationAdjuster').style.display = m === 'stopwatch' ? 'none' : 'flex';
                timer.timeLeft = m === 'stopwatch' ? 0 : 25 * 60; timer.initialSecs = timer.timeLeft;
                document.getElementById('timerStatus').innerText = m === 'stopwatch' ? 'STOPWATCH RUNNING' : 'READY TO FOCUS';
                window.app.updateUI();
            },
            adjustTime: (mins) => { if (timer.isRunning) return; let newTime = (Math.floor(timer.timeLeft / 60) + mins) * 60; if (newTime < 60) newTime = 60; timer.timeLeft = newTime; timer.initialSecs = newTime; window.app.updateUI(); },
            setDuration: (m) => { if (timer.isRunning) return; timer.mode = 'pomodoro'; timer.timeLeft = m * 60; timer.initialSecs = m * 60; window.app.updateUI(); },
            toggleTimer: () => {
                if (timer.isRunning) { clearInterval(timer.intv); timer.isRunning = false; els.circle.classList.remove('running'); els.startBtn.innerText = "RESUME"; document.getElementById('floatPlay').innerText = "START"; } 
                else {
                    timer.isRunning = true; els.circle.classList.add('running'); els.startBtn.innerText = "PAUSE"; document.getElementById('floatPlay').innerText = "PAUSE";
                    els.quote.innerText = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
                    timer.intv = setInterval(() => { if (timer.mode === 'stopwatch') timer.timeLeft++; else { if (timer.timeLeft > 0) timer.timeLeft--; else window.app.complete(); } window.app.updateUI(); }, 1000);
                }
                window.app.updateUI();
            },
            resetTimer: () => { clearInterval(timer.intv); timer.isRunning = false; els.circle.classList.remove('running'); timer.timeLeft = timer.mode === 'stopwatch' ? 0 : timer.initialSecs; els.startBtn.innerText = "START"; window.app.updateUI(); },
            complete: async () => {
                clearInterval(timer.intv); timer.isRunning = false; els.circle.classList.remove('running'); document.getElementById('beep').play(); confetti.start();
                const dur = timer.mode === 'stopwatch' ? Math.floor(timer.timeLeft / 60) : Math.floor(timer.initialSecs / 60);
                const date = new Date().toISOString().split('T')[0];
                if (dur > 0) {
                    if (window.isLocalMode || !window.user) {
                        const h = getLocal('history'); h.push({ subject: timer.sub, duration: dur, date: date, id: Date.now() }); saveLocal('history', h);
                        incrementStreakLocal(); loadLocalData();
                    } else if (window.firebaseFns.addDoc && window.db) {
                        await window.firebaseFns.addDoc(window.firebaseFns.collection(window.db, 'artifacts', appId, 'users', window.user.uid, 'history'), { subject: timer.sub, duration: dur, date: date, timestamp: window.firebaseFns.serverTimestamp() });
                        incrementStreakCloud();
                    }
                }
                document.getElementById('notification-overlay').classList.add('active');
            },
            closeNotif: () => { document.getElementById('notification-overlay').classList.remove('active'); window.app.resetTimer(); },
            addTask: async () => {
                const text = document.getElementById('taskInp').value.trim(); if (!text) return;
                if (window.isLocalMode || !window.user) { const t = getLocal('tasks'); t.push({ text, done: false, id: Date.now() }); saveLocal('tasks', t); loadLocalData(); } 
                else if (window.firebaseFns.addDoc && window.db) { await window.firebaseFns.addDoc(window.firebaseFns.collection(window.db, 'artifacts', appId, 'users', window.user.uid, 'tasks'), { text, done: false, createdAt: window.firebaseFns.serverTimestamp() }); }
                document.getElementById('taskInp').value = '';
            },
            deleteTask: async (id) => { if (window.isLocalMode || !window.user) { saveLocal('tasks', getLocal('tasks').filter(t => t.id !== id)); loadLocalData(); } else if (window.firebaseFns.deleteDoc && window.db) { await window.firebaseFns.deleteDoc(window.firebaseFns.doc(window.db, 'artifacts', appId, 'users', window.user.uid, 'tasks', id)); } },
            toggleTaskStatus: async (t) => {
                if (!t.done) { confetti.start(); document.getElementById('taskBeep').currentTime = 0; document.getElementById('taskBeep').play().catch(()=>{}); }
                const newDone = !t.done;
                if (window.isLocalMode || !window.user) { 
                    const tasks = getLocal('tasks');
                    const updated = tasks.map(item => item.id === t.id ? {...item, done: newDone} : item);
                    saveLocal('tasks', updated); 
                    loadLocalData(); 
                }
                else if (window.firebaseFns.updateDoc && window.db) await window.firebaseFns.updateDoc(window.firebaseFns.doc(window.db, 'artifacts', appId, 'users', window.user.uid, 'tasks', t.id), { done: newDone });
            },
            saveSub: async () => {
                const name = document.getElementById('newSubInp').value.toUpperCase().trim(); if (!name) return;
                if (window.isLocalMode || !window.user) { const s = getLocal('subjects'); s.push({ name, id: Date.now() }); saveLocal('subjects', s); loadLocalData(); } 
                else if (window.firebaseFns.addDoc && window.db) { await window.firebaseFns.addDoc(window.firebaseFns.collection(window.db, 'artifacts', appId, 'users', window.user.uid, 'subjects'), { name }); }
                window.app.closeModals(); document.getElementById('newSubInp').value = '';
            },
            deleteSub: async (id) => { if (window.isLocalMode || !window.user) { saveLocal('subjects', getLocal('subjects').filter(s => s.id !== id)); loadLocalData(); } else if (window.firebaseFns.deleteDoc && window.db) { await window.firebaseFns.deleteDoc(window.firebaseFns.doc(window.db, 'artifacts', appId, 'users', window.user.uid, 'subjects', id)); } },
            selectSub: (name) => { timer.sub = name; document.getElementById('activeSub').innerText = name; document.getElementById('floatSub').innerText = name; document.querySelectorAll('.subject-item').forEach(e => e.classList.toggle('active', e.dataset.name === name)); window.app.updateUI(); },
            showSettings: () => { document.getElementById('goalInp').value = timer.goal; document.getElementById('setModal').classList.add('active'); },
            saveSettings: () => { const val = parseInt(document.getElementById('goalInp').value); if (val > 0) timer.goal = val; window.app.closeModals(); loadLocalData(); },
            openSubModal: () => document.getElementById('subModal').classList.add('active'),
            closeModals: () => document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')),
            closeMini: () => { document.getElementById('floatWin').classList.remove('active'); }
        };

        function syncStreak() {
            if (window.isLocalMode || !window.user) { els.streak.innerText = (JSON.parse(localStorage.getItem('akta_streak')) || { count: 0 }).count; } 
            else if (window.firebaseFns.getDoc && window.db) { window.firebaseFns.getDoc(window.firebaseFns.doc(window.db, 'artifacts', appId, 'users', window.user.uid, 'profile', 'streak')).then(snap => { if (snap.exists()) els.streak.innerText = snap.data().count; }); }
        }

        function incrementStreakLocal() {
            const today = new Date().toISOString().split('T')[0];
            const s = JSON.parse(localStorage.getItem('akta_streak')) || { count: 0, lastDate: "" };
            if (s.lastDate !== today) { s.count++; s.lastDate = today; localStorage.setItem('akta_streak', JSON.stringify(s)); els.streak.innerText = s.count; }
        }

        async function incrementStreakCloud() {
            if (!window.user || !window.db) return;
            const streakRef = window.firebaseFns.doc(window.db, 'artifacts', appId, 'users', window.user.uid, 'profile', 'streak');
            const snap = await window.firebaseFns.getDoc(streakRef).catch(()=>null);
            const today = new Date().toISOString().split('T')[0];
            if (snap && snap.exists()) {
                const data = snap.data();
                if (data.lastDate !== today) { await window.firebaseFns.setDoc(streakRef, { count: (data.count || 0) + 1, lastDate: today }); els.streak.innerText = data.count + 1; }
            } else { await window.firebaseFns.setDoc(streakRef, { count: 1, lastDate: today }); els.streak.innerText = 1; }
        }

        function renderTasks(tasks) {
            lastLoadedTasks = tasks;
            const list = document.getElementById('taskList'); const miniList = document.getElementById('miniTaskList');
            list.innerHTML = ''; miniList.innerHTML = '';
            
            // Handle PiP render if active
            let pipList = pipWindow ? pipWindow.document.getElementById('pip-task-list') : null;
            if(pipList) pipList.innerHTML = '';

            tasks.forEach(t => {
                const createTaskItem = (mode) => {
                    const div = (mode === 'pip' && pipWindow) ? pipWindow.document.createElement('div') : document.createElement('div');
                    div.className = `todo-item ${t.done ? 'task-done' : ''}`;
                    
                    if(mode === 'mini') div.style.background = "rgba(255,255,255,0.1)";
                    if(mode === 'pip') div.style.cssText = `display:flex; align-items:center; gap:8px; padding:10px; background:rgba(255,255,255,0.05); border-radius:12px; margin-bottom:5px; border:1px solid rgba(255,255,255,0.1);`;

                    div.innerHTML = `<span style="flex:1; font-size:${mode === 'main' ? '13px' : '11px'}; cursor:pointer; color:white; font-weight:500; ${t.done ? 'text-decoration:line-through; opacity:0.5' : ''}">${t.text}</span>${mode === 'main' ? '<button class="delete-btn">√ó</button>' : ''}`;
                    
                    div.onclick = () => window.app.toggleTaskStatus(t);
                    if(mode === 'main') div.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); window.app.deleteTask(t.id); };
                    
                    return div;
                };

                list.appendChild(createTaskItem('main'));
                miniList.appendChild(createTaskItem('mini'));
                if(pipList) pipList.appendChild(createTaskItem('pip'));
            });
        }

        function renderSubjects(subs) {
            const list = document.getElementById('subList'); list.innerHTML = '';
            subs.forEach(s => {
                const div = document.createElement('div'); div.className = `subject-item ${s.name === timer.sub ? 'active' : ''}`;
                div.innerHTML = `<span style="flex:1;">üìö <b>${s.name}</b></span><button class="delete-btn">√ó</button>`;
                div.querySelector('span').onclick = () => window.app.selectSub(s.name);
                div.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); window.app.deleteSub(s.id); };
                list.appendChild(div);
            });
        }

        function renderHistory(history) {
            let todayMins = 0, totalHrs = 0;
            const today = new Date().toISOString().split('T')[0]; const map = {};
            history.forEach(h => { totalHrs += (h.duration / 60); if (h.date === today) todayMins += h.duration; map[h.date] = (map[h.date] || 0) + h.duration; });
            document.getElementById('statSess').innerText = history.length; document.getElementById('statHrs').innerText = totalHrs.toFixed(1);
            document.getElementById('goalText').innerText = `${todayMins} / ${timer.goal} min`;
            document.getElementById('goalBar').style.width = Math.min((todayMins/timer.goal)*100, 100) + '%';
            const grid = document.getElementById('actGrid'); grid.innerHTML = '';
            for(let i=35; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate()-i); const ds = d.toISOString().split('T')[0];
                const val = map[ds] || 0; const cell = document.createElement('div'); cell.className = 'activity-cell';
                if(val > 0) cell.classList.add('cell-1'); if(val > 120) cell.classList.add('cell-max'); grid.appendChild(cell);
            }
        }

        function loadLocalData() { renderTasks(getLocal('tasks')); renderSubjects(getLocal('subjects')); renderHistory(getLocal('history')); }

        window.onload = () => {
            loadLocalData(); window.app.updateUI();
            const floatWin = document.getElementById('floatWin');
            let isMoving = false, ox, oy;
            floatWin.onmousedown = (e) => { if(e.target.tagName === 'BUTTON') return; isMoving = true; ox = e.clientX - floatWin.offsetLeft; oy = e.clientY - floatWin.offsetTop; };
            document.onmousemove = (e) => { if (!isMoving) return; floatWin.style.left = (e.clientX - ox) + 'px'; floatWin.style.top = (e.clientY - oy) + 'px'; floatWin.style.bottom = 'auto'; floatWin.style.right = 'auto'; };
            document.onmouseup = () => isMoving = false;
            floatWin.ondblclick = () => { const isExp = els.miniTasks.classList.toggle('expanded'); floatWin.style.height = isExp ? '360px' : 'auto'; };
            document.getElementById('miniModeBtn').onclick = () => floatWin.classList.toggle('active');
        };

        const confetti = {
            particles: [], colors: ['#06b6d4', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'], isRunning: false, ctx: null,
            init() { this.ctx = document.getElementById('confettiCanvas').getContext('2d'); window.addEventListener('resize', () => this.resize()); this.resize(); },
            resize() { const c = document.getElementById('confettiCanvas'); c.width = window.innerWidth; c.height = window.innerHeight; },
            spawn() { this.particles = []; for (let i = 0; i < 80; i++) { this.particles.push({ x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight - window.innerHeight, size: Math.random() * 8 + 4, color: this.colors[Math.floor(Math.random() * this.colors.length)], speed: Math.random() * 3 + 2, angle: Math.random() * 360, rotationSpeed: Math.random() * 10 - 5 }); } },
            start() { if (this.isRunning) return; this.spawn(); this.isRunning = true; this.animate(); setTimeout(() => this.isRunning = false, 3500); },
            animate() { if (!this.isRunning && this.particles.length === 0) { this.ctx.clearRect(0, 0, window.innerWidth, window.innerHeight); return; } this.ctx.clearRect(0, 0, window.innerWidth, window.innerHeight); for (let i = 0; i < this.particles.length; i++) { let p = this.particles[i]; p.y += p.speed; p.angle += p.rotationSpeed; this.ctx.save(); this.ctx.translate(p.x, p.y); this.ctx.rotate(p.angle * Math.PI / 180); this.ctx.fillStyle = p.color; this.ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size); this.ctx.restore(); if (p.y > window.innerHeight) { if (this.isRunning) { p.y = -20; p.x = Math.random() * window.innerWidth; } else { this.particles.splice(i, 1); i--; } } } requestAnimationFrame(() => this.animate()); }
        };
        confetti.init();
    </script>

    <script type="module">
        const userFirebaseConfig = {
            apiKey: "AIzaSyBPvkMBBPNBE81N8q0U2lH64VNCaNDirsc",
            authDomain: "safelivebakerypos.firebaseapp.com",
            projectId: "safelivebakerypos",
            storageBucket: "safelivebakerypos.firebasestorage.app",
            messagingSenderId: "158134703948",
            appId: "1:158134703948:web:39cd3936bc622a86d861e9"
        };

        async function startApp() {
            const els = { authDot: document.getElementById('authDot'), authText: document.getElementById('authText'), retryBtn: document.getElementById('retrySyncBtn') };
            if (!navigator.onLine) { window.switchToLocalMode("Local Mode (Offline)"); return; }
            window.connTimeout = setTimeout(() => { if (!window.user && !window.isLocalMode) { els.retryBtn.style.display = "inline-block"; els.authText.innerText = "Sync Hanging..."; } }, 5000);
            try {
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const { getAuth, signInAnonymously, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const fStore = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                Object.assign(window.firebaseFns, fStore, { onAuthStateChanged });
                const fbApp = initializeApp(userFirebaseConfig);
                const auth = getAuth(fbApp); 
                window.db = fStore.getFirestore(fbApp);
                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        clearTimeout(window.connTimeout);
                        window.user = u;
                        els.authDot.style.background = '#10b981';
                        els.authText.innerText = "Cloud Synced";
                        els.retryBtn.style.display = "none";
                        syncStreak();
                        loadRealtimeData(u);
                    }
                });
                await signInAnonymously(auth).catch(() => window.switchToLocalMode("Auth Error"));
            } catch (err) {
                window.switchToLocalMode("Local Mode (Sync Disabled)");
            }
        }

        function loadRealtimeData(currentUser) {
            if (!currentUser || !window.firebaseFns.collection || !window.db) return;
            const { collection, query, orderBy, onSnapshot } = window.firebaseFns;
            const errorFn = (err) => { if(err.code === 'permission-denied') window.switchToLocalMode("Cloud Permission Denied"); };
            onSnapshot(query(collection(window.db, 'artifacts', appId, 'users', currentUser.uid, 'tasks'), orderBy('createdAt', 'desc')), (s) => { const tasks = []; s.forEach(d => tasks.push({ ...d.data(), id: d.id })); renderTasks(tasks); }, errorFn);
            onSnapshot(collection(window.db, 'artifacts', appId, 'users', currentUser.uid, 'subjects'), (s) => { const subs = []; s.forEach(d => subs.push({ ...d.data(), id: d.id })); renderSubjects(subs); }, errorFn);
            onSnapshot(collection(window.db, 'artifacts', appId, 'users', currentUser.uid, 'history'), (s) => { const hist = []; s.forEach(d => hist.push({ ...d.data(), id: d.id })); renderHistory(hist); }, errorFn);
        }
        startApp();
    </script>
</body>
</html>
